apiVersion: iamlite.manetu.io/v1alpha3
kind: PolicyDomain
metadata:
  name: beta
spec:
  policies:
    - mrn: &mainapi "mrn:iam:policy:mainapi"
      name: mainapi
      description: "This policy is the main rego for apis which handles jwt and more"
      rego: |
        package authz
        default allow = 0
        jwt_ok {
        	input.principal != {}
        }
        allow = -1 {
            not jwt_ok
        }        

    - mrn: &allow-all "mrn:iam:policy:allow-all"
      name: allow-all
      description: "This policy allows full access"
      rego: |
        package authz
        default allow = true        

    - mrn: &no-access "mrn:iam:policy:no-access"
      name: no-access
      description: "This policy denies all access requests"
      rego: |
        package authz       
        default allow = false        

    - mrn: &read-only "mrn:iam:policy:read-only"
      name: read-only
      description: "This policy has read-only access to the entire realm"
      dependencies:
        - "alpha/mrn:iam:library:helpers"
      rego: |
        package authz
        import data.helpers
        default allow = false
        allow {
                helpers.match_any(permitted_operations, input.operation)
        }
        permitted_operations := {
                "*:get",
                "*:head",
        }  

    - mrn: &share-by-clearance "mrn:iam:policy:share-by-clearance"
      name: share-by-clearance
      description: "Resource policy for sharing resources based on the caller's security clearance"
      dependencies:
        - "alpha/mrn:iam:library:helpers"
      rego: |
        package authz
        import data.helpers
        import data.utils
        default allow = false
        allow {
            is_readonly
            has_clearance
        }
        allow {
            is_owner
        }
        ratings := {"LOW": 1, "MODERATE": 2, "HIGH": 3, "MAXIMUM": 4, "UNASSIGNED": 5}
        has_clearance {
        	ratings[input.principal.mclearance] >= ratings[input.resource.classification]
        }
        is_readonly {
            helpers.match_any(utils.ro_operations, input.operation)
        }
        is_owner {
            input.principal.sub == input.resource.owner
        }

  roles:
    - mrn: &admin-role "mrn:iam:role:admin"
      name: admin
      policy: *allow-all
    - mrn: "mrn:iam:role:no-access"
      name: no-access
      policy: *no-access
  
  groups:
    - mrn: "mrn:iam:group:admin"
      name: admin
      roles:
        - *admin-role
  
  resource-groups:
    - mrn: "mrn:iam:resource-group:allow-all"
      name: allow-all
      default: true
      policy: *allow-all
    - mrn: "mrn:iam:resource-group:share-by-clearance"
      name: share-by-clearance
      policy: *share-by-clearance
  
  scopes:
    - mrn: "mrn:iam:scope:api"
      name: api
      policy: *allow-all
    - mrn: "mrn:iam:scope:read-api"
      name: read_api
      policy: *read-only
  
  # Test with various anchoring patterns
  operations:
    - name: alpha
      selector:
        - "^alpha:.*"      # Start anchor only
      policy: *no-access
    - name: beta
      selector:
        - "^beta:.*$"      # Both anchors
      policy: *read-only
    - name: gamma
      selector:
        - "gamma:.*$"      # End anchor only
      policy: *no-access
    - name: delta
      selector:
        - "^delta:.*$"     # Both anchors (explicit)
      policy: *read-only
    - name: api
      selector:
        - ".*"             # No anchors (catch-all)
      policy: *mainapi