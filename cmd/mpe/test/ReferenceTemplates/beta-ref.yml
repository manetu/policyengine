apiVersion: iamlite.manetu.io/v1alpha3
kind: PolicyDomainReference
metadata:
  name: beta
spec:
  policies:
    - mrn: &mainapi "mrn:iam:policy:mainapi"
      name: mainapi
      description: "This policy is the main rego for apis which handles jwt and more"
      rego_filename: "test/ReferenceTemplates/mainapi.rego"

    - mrn: &allow-all "mrn:iam:policy:allow-all"
      name: allow-all
      description: "This policy allows full access"
      rego: |
        package authz
        default allow = true

    - mrn: &no-access "mrn:iam:policy:no-access"
      name: no-access
      description: "This policy denies all access requests"
      rego: |
        package authz
        default allow = false

    - mrn: &read-only "mrn:iam:policy:read-only"
      name: read-only
      description: "This policy has read-only access to the entire realm"
      dependencies:
        - "alpha/mrn:iam:library:helpers"
      rego: |
        package authz
        import data.helpers

        default allow = false

        allow {
                helpers.match_any(permitted_operations, input.operation)
        }

        permitted_operations := {
                "*:get",
                "*:head",
        }

    - mrn: &share-by-clearance "mrn:iam:policy:share-by-clearance"
      name: share-by-clearance
      description: "Resource policy for sharing resources based on the caller's security clearance"
      dependencies:
        - "alpha/mrn:iam:library:helpers"
      rego: |
        package authz
        import data.helpers
        import data.utils

        default allow = false

        allow {
            is_readonly
            has_clearance
        }

        allow {
            is_owner
        }

        ratings := {"LOW": 1, "MODERATE": 2, "HIGH": 3, "MAXIMUM": 4, "UNASSIGNED": 5}

        has_clearance {
        	ratings[input.principal.mclearance] >= ratings[input.resource.classification]
        }

        is_readonly {
            helpers.match_any(utils.ro_operations, input.operation)
        }

        is_owner {
            input.principal.sub == input.resource.owner
        }

  roles:
    - mrn: &admin-role "mrn:iam:role:admin"
      name: admin
      description: "This role is appropriate for an administrator"
      policy: *allow-all
      annotations:
        - name: foo
          value: "42"
        - name: bar
          value: "[1, 2, 3]"
        - name: baz
          value: "{\"bat\": 42}"
    - mrn: "mrn:iam:role:no-access"
      name: no-access
      description: "This role will deny all access"
      policy: *no-access

  groups:
    - mrn: "mrn:iam:group:admin"
      name: admin
      description: "This group is appropriate for administrators"
      roles:
        - *admin-role
      annotations:
        - name: foo
          value: "42"
        - name: bar
          value: "[1, 2, 3]"
        - name: baz
          value: "{\"bat\": 42}"

  resource-groups:
    - mrn: "mrn:iam:resource-group:allow-all"
      name: allow-all
      description: "Resources in this group may be fully controlled by any authenticated user"
      default: true                                                          # this is the resource-group to use as the default if the resource does not specify
      policy: *allow-all
      annotations:
        - name: foo
          value: "42"
        - name: bar
          value: "[1, 2, 3]"
        - name: baz
          value: "{\"bat\": 42}"

    - mrn: "mrn:iam:resource-group:share-by-clearance"
      name: share-by-clearance
      description: "Resources in this group are shared (read-only) based on classification and security clearance"
      policy: *share-by-clearance

  scopes:
    - mrn: "mrn:iam:scope:api"
      name: api
      description: "This scope grants the user complete read/write access to the API up to the resource-owners entitlement level"
      policy: *allow-all
      annotations:
        - name: foo
          value: "42"
        - name: bar
          value: "[1, 2, 3]"
        - name: baz
          value: "{\"bat\": 42}"
    - mrn: "mrn:iam:scope:read-api"
      name: read_api
      description: "This scope grants the user read-only access to the API up to the resource-owners entitlement level"
      policy: *read-only

  # Operations and mappings are evaluated in order: first match
  # will return the associated policies.
  # A selector must be a valid regex https://github.com/google/re2.
  # Within an operation, the selectors are OR'ed together to create
  # a regexp for matching.
  operations:
    - name: api
      selector:
        - ".*"
      policy: *mainapi

  mappers:
    - name: common-mapper
      selector:
        - ".*"  # matches service-account name of the calling pod
      rego_filename: "test/ReferenceTemplates/common-mapper.rego"

